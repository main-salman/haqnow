# üîí Security Best Practices for Kubernetes

## ‚ö†Ô∏è NEVER Commit Sensitive Credentials

**Kubeconfig files contain sensitive credentials and MUST NEVER be committed to git.**

## Protected Files

The following files are gitignored and contain sensitive information:

- `k8s/.kubeconfig` - Kubernetes cluster credentials (client certificates and keys)
- `k8s/manifests/umami-secrets.yaml` - Umami DB URL and app secret (generated by Terraform; never commit)
- `.env` - All environment variables including API keys, database passwords, etc.
- `*.pem`, `*.key`, `*.crt` - Certificate and key files

## How Kubeconfig is Generated

The kubeconfig file is automatically generated by Terraform when creating the SKS cluster:

```bash
cd terraform
terraform apply
```

This creates `k8s/.kubeconfig` (note the leading dot - it's gitignored).

## Using Kubeconfig

Scripts automatically detect and use the kubeconfig:

```bash
# Most scripts auto-detect
./scripts/deploy.sh patch

# Or manually set
export KUBECONFIG="$(pwd)/k8s/.kubeconfig"
kubectl get pods -n haqnow
```

## If Kubeconfig is Accidentally Committed

If you accidentally commit kubeconfig or other sensitive files:

1. **Immediately rotate credentials**:
   ```bash
   # Regenerate kubeconfig via Terraform
   cd terraform
   terraform apply -replace=exoscale_sks_kubeconfig.haqnow[0]
   ```

2. **Remove from git history**:
   ```bash
   git rm --cached k8s/kubeconfig  # If it was committed
   git commit -m "Remove sensitive kubeconfig file"
   ```

3. **Verify it's gitignored**:
   ```bash
   git check-ignore k8s/.kubeconfig
   # Should output: k8s/.kubeconfig
   ```

## Best Practices

1. ‚úÖ Always use `.kubeconfig` (with leading dot) - it's gitignored
2. ‚úÖ Never commit files with `kubeconfig` in the name
3. ‚úÖ Store sensitive values in `.env` (already gitignored)
4. ‚úÖ Use Terraform outputs to reference paths, not hardcoded values
5. ‚úÖ Rotate credentials immediately if exposed

## If Umami or RAG database credentials were exposed

If `umami-secrets.yaml` or any database URL (e.g. RAG PostgreSQL) was committed or leaked:

1. **Rotate the credentials** in the Exoscale/Aiven DBaaS console (reset the user password).
2. Update Terraform variables (e.g. `umami_db_password`) or `.env` (e.g. `POSTGRES_RAG_URI`) with the new values.
3. Regenerate and re-apply secrets: `cd terraform && terraform apply`, then `kubectl apply -f k8s/manifests/umami-secrets.yaml` (and restart any pods using the RAG DB).
4. Ensure `k8s/manifests/umami-secrets.yaml` is in `.gitignore` and never commit it again.

## GitGuardian Integration

This repository uses GitGuardian to detect secrets. If you see alerts:

1. **Don't panic** - GitGuardian alerts are warnings
2. **Check if file is gitignored** - If yes, it's safe (local only)
3. **If committed** - Remove from tracking, add to `.gitignore`, then rotate the exposed credentials (see above).
4. **Update .gitignore** - Add patterns to prevent future commits

