# Umami Analytics Setup for HaqNow

Self-hosted, privacy-focused web analytics for tracking visitor metrics without compromising user privacy.

## Features
- **Privacy-first**: No cookies, GDPR compliant
- **Lightweight**: ~1KB tracking script
- **Real-time**: Live visitor data
- **Geographic**: Country-level visitor data
- **Page views**: Track which pages are visited
- **Referrers**: See where traffic comes from

## Architecture

Umami uses:
- **Database**: Exoscale DBaaS PostgreSQL (managed via Terraform)
- **Application**: Runs on SKS Kubernetes cluster
- **Access**: `https://www.haqnow.com/monitoring`

## Deployment Steps

### 1. Configure Terraform Variables

Edit `terraform/terraform.tfvars` and set the Umami credentials:

```bash
# Generate secure values
openssl rand -base64 24   # For umami_db_password
openssl rand -hex 32      # For umami_app_secret
```

Update in `terraform/terraform.tfvars`:
```hcl
umami_enabled       = true
umami_postgres_plan = "hobbyist-2"
umami_db_password   = "your_generated_password"
umami_app_secret    = "your_generated_32_char_secret"
```

### 2. Apply Terraform

```bash
cd terraform
terraform plan    # Review changes
terraform apply   # Creates database + generates K8s secrets
```

This will:
- Create PostgreSQL database on Exoscale DBaaS
- Generate `k8s/manifests/umami-secrets.yaml` with connection details

### 3. Deploy to Kubernetes

```bash
# Apply the secrets (auto-generated by Terraform)
kubectl apply -f k8s/manifests/umami-secrets.yaml

# Deploy Umami application
kubectl apply -f k8s/manifests/umami-deployment.yaml

# Check status
kubectl get pods -n umami
kubectl logs -n umami -l app=umami
```

### 4. Initial Setup

1. Access Umami at `https://www.haqnow.com/monitoring`
2. Login with the default credentials (see Umami documentation)
3. **IMMEDIATELY change the password** in Settings → Profile
4. Add your website:
   - Go to Settings → Websites → Add website
   - Name: `HaqNow`
   - Domain: `www.haqnow.com`
5. Copy the website ID

### 5. Update Frontend Tracking

Update `frontend/index.html` with your website ID:

```html
<script defer src="https://www.haqnow.com/monitoring/script.js" 
        data-website-id="YOUR_WEBSITE_ID_HERE"></script>
```

Then deploy:
```bash
./scripts/deploy.sh patch
```

## What Data is Collected

Umami collects:
- Page URL visited
- Referrer URL
- Browser type (generic)
- Operating system (generic)
- Device type (desktop/mobile/tablet)
- Country (from IP, IP not stored)
- Screen size (generic buckets)

Umami does NOT collect:
- Personal information
- IP addresses (hashed only)
- Cookies
- User tracking across sessions

## Troubleshooting

### Check Umami Pod Status
```bash
kubectl get pods -n umami
kubectl describe pod -n umami -l app=umami
```

### View Logs
```bash
kubectl logs -n umami -l app=umami -f
```

### Check Database Connection
```bash
kubectl exec -n umami -it deploy/umami -- \
  sh -c 'echo "SELECT 1" | psql $DATABASE_URL'
```

## Cost

- **Database**: Exoscale DBaaS hobbyist-2 (~$15/month)
- **Compute**: Shared with existing SKS cluster (minimal additional cost)

## Maintenance

The database is automatically backed up daily by Exoscale DBaaS at 4 AM UTC.

To manually backup:
```bash
# Get connection string from Terraform output
cd terraform
terraform output -raw umami_postgres_uri

# Backup
pg_dump "$CONNECTION_STRING" > umami_backup_$(date +%Y%m%d).sql
```
